<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Dashboard - Transportation System</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <script th:src="@{/js/auth.js}"></script>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <main class="container">
        <h1>Support Agent Dashboard</h1>
        
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-title">Pending Orders</div>
                <div class="stat-value" id="pending-orders">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">In Transit</div>
                <div class="stat-value" id="in-transit-orders">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Delivered</div>
                <div class="stat-value" id="delivered-orders">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Available Drivers</div>
                <div class="stat-value" id="available-drivers">--</div>
            </div>
        </div>
        
        <div class="dashboard-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <a href="/support/orders" class="btn btn-primary">Manage Orders</a>
                <a href="/support/vehicles" class="btn btn-primary">Manage Vehicles</a>
            </div>
        </div>
        
        <div class="dashboard-recent">
            <h2>Recent Orders</h2>
            <div id="loading" class="loading">Loading recent orders...</div>
            <div id="recent-orders-container" style="display: none;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recent-orders">
                        <!-- Recent orders will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <div th:replace="fragments/footer :: footer"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated and has SUPPORT_AGENT role
            if (!isAuthenticated() || !hasRole('SUPPORT_AGENT')) {
                window.location.href = '/login';
                return;
            }
            
            // Load dashboard data
            loadDashboardStats();
            loadRecentOrders();
        });
        
        function loadDashboardStats() {
            // Load order statistics
            fetch('/api/support/orders', {
                headers: {
                    'Authorization': 'Bearer ' + getToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }
                return response.json();
            })
            .then(orders => {
                console.log('Orders loaded:', orders);
                // Count orders by status
                const pendingCount = orders.filter(order => order.status.statusName === 'PENDING').length;
                const inTransitCount = orders.filter(order => order.status.statusName === 'IN_TRANSIT').length;
                const deliveredCount = orders.filter(order => order.status.statusName === 'DELIVERED').length;
                
                // Update stats
                document.getElementById('pending-orders').textContent = pendingCount;
                document.getElementById('in-transit-orders').textContent = inTransitCount;
                document.getElementById('delivered-orders').textContent = deliveredCount;
            })
            .catch(error => {
                console.error('Error loading order statistics:', error);
                document.getElementById('pending-orders').textContent = 'Error';
                document.getElementById('in-transit-orders').textContent = 'Error';
                document.getElementById('delivered-orders').textContent = 'Error';
            });
            
            // Load driver statistics
            fetch('/api/support/orders/drivers', {
                headers: {
                    'Authorization': 'Bearer ' + getToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load drivers');
                }
                return response.json();
            })
            .then(drivers => {
                console.log('Drivers loaded:', drivers);
                document.getElementById('available-drivers').textContent = drivers.length;
            })
            .catch(error => {
                console.error('Error loading driver statistics:', error);
                document.getElementById('available-drivers').textContent = 'Error';
            });
        }
        
        function loadRecentOrders() {
            fetch('/api/support/orders', {
                headers: {
                    'Authorization': 'Bearer ' + getToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }
                return response.json();
            })
            .then(orders => {
                console.log('Recent orders loaded:', orders);
                document.getElementById('loading').style.display = 'none';
                
                // Sort orders by creation date (newest first) and take only the first 5
                const recentOrders = orders
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 5);
                
                const tableBody = document.getElementById('recent-orders');
                tableBody.innerHTML = '';
                
                if (recentOrders.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="5" style="text-align: center;">No orders found</td>';
                    tableBody.appendChild(row);
                } else {
                    recentOrders.forEach(order => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const createdDate = new Date(order.createdAt);
                        const formattedDate = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                        
                        row.innerHTML = `
                            <td>${order.id}</td>
                            <td>${order.customer.firstName} ${order.customer.lastName}</td>
                            <td>${order.status.statusName}</td>
                            <td>${formattedDate}</td>
                            <td>
                                <a href="/support/orders/${order.id}" class="btn btn-primary">View Details</a>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
                
                document.getElementById('recent-orders-container').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading recent orders:', error);
                document.getElementById('loading').textContent = 'Error loading recent orders. Please try again.';
            });
        }
    </script>
</body>
</html>
